- name: Setup
  hosts: localhost
  tasks:
    # Install
    - name: Check Homebrew
      ansible.builtin.command: which brew
      changed_when: homebrew.rc != 0
      failed_when: false
      register: homebrew
    - name: Install Homebrew
      ansible.builtin.shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      become: true
      become_user: "{{ ansible_user_id }}"
      changed_when: true
      when: homebrew.rc != 0

    - name: Install Homebrew formula
      community.general.homebrew:
        name: "{{ item }}"
      loop:
        - fish
        - mise
        - neovim
        - tldr

    - name: Install Homebrew cask
      community.general.homebrew_cask:
        name: "{{ item }}"
      loop:
        - arc
        - jetbrains-toolbox
        - raycast
        - warp

    - name: Install Node.js
      ansible.builtin.command: mise use --global node@20
      register: node
      changed_when: "'installed' in node.stderr"

    - name: Install pnpm
      ansible.builtin.command: mise use --global pnpm --yes
      register: pnpm
      changed_when: "'installed' in pnpm.stderr"

    # Configure
    - name: Tap to click
      community.general.osx_defaults:
        domain: com.apple.AppleMultitouchTrackpad
        key: Clicking
        type: int
        value: 1

    - name: Set fish shell
      become: true
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: /opt/homebrew/bin/fish
    - name: Create fish directory
      ansible.builtin.file:
        mode: u=rwx,g=rx,o=rx
        path: ~/.config/fish
        state: directory

    - name: Add Homebrew to PATH
      ansible.builtin.lineinfile:
        create: true
        line: eval "$(/opt/homebrew/bin/brew shellenv)"
        mode: u=rw,g=r,o=r
        path: ~/.config/fish/config.fish

    - name: Configure ~/.gitconfig
      community.general.git_config:
        name: "{{ item.name }}"
        scope: global
        value: "{{ item.value }}"
      loop:
        - name: user.name
          value: Bastien Sun
        - name: user.email
          value: 43788700+bastiensun@users.noreply.github.com
        - name: core.editor
          value: nvim

    - name: Generate SSH key
      community.crypto.openssh_keypair:
        path: ~/.ssh/id_ed25519
        type: ed25519
